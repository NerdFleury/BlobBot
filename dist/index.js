"use strict";var j=Object.create;var y=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var V=(t,n,e,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of k(n))!H.call(t,r)&&r!==e&&y(t,r,{get:()=>n[r],enumerable:!(o=K(n,r))||o.enumerable});return t};var Y=(t,n,e)=>(e=t!=null?j(L(t)):{},V(n||!t||!t.__esModule?y(e,"default",{value:t,enumerable:!0}):e,t));var d=(t,n,e)=>new Promise((o,r)=>{var a=s=>{try{l(e.next(s))}catch(i){r(i)}},c=s=>{try{l(e.throw(s))}catch(i){r(i)}},l=s=>s.done?o(s.value):Promise.resolve(s.value).then(a,c);l((e=e.apply(t,n)).next())});var p=require("discord.js");var h=require("discord.js");var S=Y(require("dotenv"));S.default.config();var{DISCORD_TOKEN:$,DISCORD_CLIENT_ID:P,MONGO_USER:E,MONGO_PASSWORD:A,GET_PLAYER_V1_API:C,GET_RECENT:R,OSU_API:w,V1_API:T,LEADERBOARD:O}=process.env;if(!$||!P||!A||!E||!C||!R||!w||!T||!O)throw new Error("Missing environment variables");var m={DISCORD_TOKEN:$,DISCORD_CLIENT_ID:P,MONGO_USER:E,MONGO_PASSWORD:A,GET_PLAYER_V1_API:C,GET_RECENT:R,OSU_API:w,V1_API:T,LEADERBOARD:O};function D(t){return d(this,null,function*(){let{beatmap_id:n,nkatu:e,ngeki:o,n100:r,n50:a,misses:c,mods:l,mode:s,combo:i}=t;console.log(n,e,o,r,a,c,l,s,i);let g=new URLSearchParams({id:n==null?void 0:n.toString(),nkatu:e==null?void 0:e.toString(),ngeki:o==null?void 0:o.toString(),n100:r==null?void 0:r.toString(),n50:a==null?void 0:a.toString(),misses:c.toString(),mods:l.toString(),mode:s.toString(),combo:i==null?void 0:i.toString()});try{let u=yield fetch(`${m.V1_API}/calculate_pp?${g.toString()}`,{method:"GET",headers:{Authorization:`Bearer ${m.OSU_API}`}});if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);return yield u.json()}catch(u){throw console.error("Error calculating PP:",u),u}})}function W(t){let n=[];for(let[e,o]of Object.entries(X))t&o&&n.push(e);return n}var X={NM:0,NF:1,EZ:2,TD:4,HD:8,HR:16,SD:32,DT:64,RX:128,HT:256,NC:512,FL:1024,AT:2048,SO:4096,AP:8192,PF:16384,"4K":32768,"5K":65536,"6K":1<<17,"7K":1<<18,"8K":1<<19,FADEIN:1<<20,RANDOM:1<<21,CINEMA:1<<22,TARGET:1<<23,KEY9:1<<24,KEYCOOP:1<<25,KEY1:1<<26,KEY3:1<<27,KEY2:1<<28,SCOREV2:1<<29,MR:1<<30};function x(t){return d(this,null,function*(){let e=yield(yield fetch(`${m.GET_RECENT}/?scope=recent&id=${t}`,{method:"GET",headers:{"Content-Type":"application/json"}})).json(),r=yield yield D({beatmap_id:e.scores[0].beatmap.id,nkatu:e.scores[0].nkatu,ngeki:e.scores[0].ngeki,n100:e.scores[0].n100,n50:e.scores[0].n50,misses:e.scores[0].nmiss,mods:e.scores[0].mods,mode:e.scores[0].mode,combo:e.scores[0].beatmap.max_combo});if(console.log(r),e.scores.length==0)return new h.EmbedBuilder().setColor(32896).setDescription(`No recent scores found for user ${e.player.name} on blobsu.`);let a=e.scores[0].play_time,c=new Date(a),l=c.getHours(),s=c.getMinutes(),i=`${l.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`,g=(c.getMonth()+1).toString().padStart(2,"0"),u=c.getDate().toString().padStart(2,"0"),_=c.getFullYear(),G=`${g}/${u}/${_}`,N={XH:"<:XH_:1254833993799438470>",X:"<:X_:1254833991740162088>",SH:"<:SH_:1254833968801644576>",S:"<:S_:1254833966603702312>",A:"<:A_:1254833995686875187>",B:"<:B_:1254833997977096293>",C:"<:C_:1254834005472182303>",D:"<:D_:1254834007867260998>",F:"<:F_:1254834013831696424>"},F=W(e.scores[0].mods).join(""),I=e.scores[0].score.toLocaleString("en-US");return new h.EmbedBuilder().setColor(32896).setTitle(`${e.scores[0].beatmap.title} [${e.scores[0].beatmap.version}] [${r.difficulty.stars.toFixed(2)}\u2605]`).setURL(`https://osu.ppy.sh/beatmapsets/${e.scores[0].beatmap.set_id}#osu/${e.scores[0].beatmap.id}`).setAuthor({name:`Recent Blobsu Standard Play for ${e.player.name}`,iconURL:"https://cdn.discordapp.com/attachments/1255451784550285323/1255451948254101564/Untitled-1.png?ex=667d2e3d&is=667bdcbd&hm=288a84334511bfc4fde8f3b5e68d9b9a3156165b39094730e93ac7f759fe41c8&"}).setThumbnail(`https://assets.ppy.sh/beatmaps/${e.scores[0].beatmap.set_id}/covers/list.jpg`).addFields({name:"Stats:",value:`\`Score:\`\u2003\u2003\u2003\u2002\u2005${I}
\`Combo:\`\u2003\u2003\u2003\u2002\u2005${e.scores[0].max_combo}/${e.scores[0].beatmap.max_combo}x
\`Mods:\`\u2003\u2003\u2003\u2002\u2002\u2005+${F}
\`Ranking:\`\u2003\u2003\u2002${N[e.scores[0].grade]}
\`Accuracy:\`\u2003\u2003\u2002${e.scores[0].acc.toFixed(2)}%
\`Hits:\`\u2003\u2003\u2003\u2003\u2006\u2005(${e.scores[0].n300}/${e.scores[0].n100}/${e.scores[0].n50}/${e.scores[0].nmiss})

\`PP:\`\u2003\u2003\u2003\u2003\u2002\u2006\u2002\u2005${e.scores[0].pp.toFixed(2)} PP
\`if FC:\`\u2003\u2003\u2003\u2002\u2005\u2006${r.performance.pp.toFixed(2)} PP`}).setFooter({text:`Standard beatmap by ${e.scores[0].beatmap.creator} played @ ${i} on ${G}`})})}var f=require("mongodb");function v(e){return d(this,arguments,function*({message:t,coll:n}){let o=t.content.split(" ");if(o.length<2){t.channel.send("Please provide a valid username to link to");return}let a=yield(yield fetch(`${m.GET_PLAYER_V1_API}?scope=info&name=${o[1]}`,{method:"GET",headers:{"Content-Type":"application/json"}})).json();if(a.status!=="success"){t.channel.send(`User \`${o[1]}\` does not exist on blobsu`);return}let c={discordUser:t.author.username},l={$set:{discordUser:t.author.username,osuUser:a.player.info.id}},s={upsert:!0};try{yield n.updateOne(c,l,s).then(()=>{t.channel.send(`Your name is now configured to \`${o[1]}\` `)})}catch(i){console.log(i),t.channel.send("An error has occurred. Blame Pana")}})}var U=require("discord.js");function q({element:t,leaderboard:n}){let e="";for(let o of n)e=e+`\`${o[t]}\`
`;return e}function z({element:t,leaderboard:n}){let e="";for(let o of n)e=e+`\`${o[t]}\`
`;return e}function Z(t){let n="",e=0;for(let o in t)e==0?(e++,n=n+`:first_place:
`):e==1?(e++,n=n+`:second_place:
`):e==2?(e++,n=n+`:third_place:
`):(e++,n=n+`\`#${e}\`
`);return n}function B(){return d(this,null,function*(){try{let e=(yield(yield fetch(`${process.env.LEADERBOARD}?sort=pp&mode=0&limit=25&offset=0`,{method:"GET",headers:{"Content-Type":"application/json"}})).json()).leaderboard,o=e[0];return new U.EmbedBuilder().setColor(32896).setTitle("Global leaderboards for blobsu").addFields({name:"`Rank`",value:Z(e),inline:!0},{name:"`Player`",value:z({element:"name",leaderboard:e}),inline:!0},{name:"`PP`",value:q({element:"pp",leaderboard:e}),inline:!0})}catch(t){console.log(t);return}})}var b=new p.Client({intents:[p.GatewayIntentBits.Guilds,p.GatewayIntentBits.GuildMessages,p.GatewayIntentBits.MessageContent]});var J=`mongodb+srv://BlobBot:${m.MONGO_PASSWORD}@clusterdemo.rpspo.mongodb.net/?retryWrites=true&w=majority&appName=ClusterDemo`,Q=new f.MongoClient(J,{serverApi:{version:f.ServerApiVersion.v1,strict:!0,deprecationErrors:!0}}),ee=Q.db("Players"),M=ee.collection("data");b.on("ready",()=>{var t;console.log("Bot is ready"),(t=b.user)==null||t.setActivity("Watching over Blobsu server")});b.on("messageCreate",t=>d(exports,null,function*(){if(!t.author.bot){if(t.content.startsWith(">setuser")&&v({message:t,coll:M}),t.content.startsWith(">leaderboard")||t.content.startsWith(">lb"))try{let n=yield B();t.channel.send({embeds:[n]})}catch(n){return t.channel.send("An error has occurred. Blame Pana")}if(t.content===">rs"){let n={discordUser:t.author.username},e={osuUser:1};try{yield M.findOne(n,{projection:e}).then(o=>d(exports,null,function*(){if(Object.is(o==null?void 0:o.osuUser,void 0))return t.channel.send("No user hasn't been set with `>setuser [user]` or no longer exists");let a=yield x(o.osuUser);t.channel.send({embeds:[a]})}))}catch(o){return console.log(o),t.channel.send("An error has occurred. Blame Pana")}}}}));b.login(m.DISCORD_TOKEN);
